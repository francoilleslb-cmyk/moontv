<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Moon TV â€” Panel de Canales</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VARIABLES & RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:          #080c10;
  --bg2:         #0e1318;
  --bg3:         #141b22;
  --border:      #1e2a35;
  --border2:     #263040;
  --accent:      #00c2ff;
  --accent2:     #0088cc;
  --green:       #00e676;
  --red:         #ff4444;
  --yellow:      #ffd600;
  --text:        #e8f0f8;
  --text2:       #7a9bb5;
  --text3:       #3d5570;
  --radius:      10px;
  --shadow:      0 4px 24px rgba(0,0,0,.5);
  --font:        'Syne', sans-serif;
  --mono:        'DM Mono', monospace;
  --transition:  .18s cubic-bezier(.4,0,.2,1);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  overflow-x: hidden;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar {
  width: 230px;
  min-height: 100vh;
  background: var(--bg2);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0; left: 0; bottom: 0;
  z-index: 100;
}

.sidebar-logo {
  padding: 28px 24px 20px;
  border-bottom: 1px solid var(--border);
}

.sidebar-logo .logo-icon {
  font-size: 28px;
  display: block;
  margin-bottom: 6px;
}

.sidebar-logo h1 {
  font-size: 18px;
  font-weight: 800;
  letter-spacing: -.3px;
  color: var(--text);
}

.sidebar-logo span {
  font-size: 11px;
  color: var(--text2);
  font-weight: 400;
  letter-spacing: .5px;
  text-transform: uppercase;
}

.sidebar-nav {
  padding: 16px 12px;
  flex: 1;
}

.nav-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text3);
  padding: 12px 12px 6px;
  font-weight: 600;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  color: var(--text2);
  transition: var(--transition);
  margin-bottom: 2px;
  user-select: none;
}

.nav-item:hover {
  background: var(--bg3);
  color: var(--text);
}

.nav-item.active {
  background: rgba(0,194,255,.1);
  color: var(--accent);
}

.nav-item .icon { font-size: 16px; width: 20px; text-align: center; }

.nav-badge {
  margin-left: auto;
  background: var(--accent);
  color: var(--bg);
  font-size: 10px;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 20px;
  font-family: var(--mono);
}

.sidebar-footer {
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  font-size: 12px;
  color: var(--text3);
}

.sidebar-footer .api-url {
  font-family: var(--mono);
  color: var(--text2);
  font-size: 11px;
  margin-top: 4px;
  word-break: break-all;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN CONTENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main {
  margin-left: 230px;
  flex: 1;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOPBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 18px 32px;
  border-bottom: 1px solid var(--border);
  background: var(--bg2);
  position: sticky;
  top: 0;
  z-index: 50;
}

.topbar h2 {
  font-size: 20px;
  font-weight: 800;
  flex: 1;
}

.search-box {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: 8px;
  padding: 8px 14px;
  width: 280px;
  transition: var(--transition);
}

.search-box:focus-within {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(0,194,255,.12);
}

.search-box input {
  background: none;
  border: none;
  outline: none;
  color: var(--text);
  font-family: var(--font);
  font-size: 14px;
  width: 100%;
}

.search-box input::placeholder { color: var(--text3); }
.search-box .search-icon { color: var(--text3); font-size: 15px; }

.btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 9px 18px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-family: var(--font);
  font-size: 13px;
  font-weight: 700;
  transition: var(--transition);
  white-space: nowrap;
}

.btn-primary {
  background: var(--accent);
  color: var(--bg);
}

.btn-primary:hover {
  background: #33cfff;
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(0,194,255,.3);
}

.btn-ghost {
  background: var(--bg3);
  color: var(--text2);
  border: 1px solid var(--border2);
}

.btn-ghost:hover {
  background: var(--border);
  color: var(--text);
}

.btn-danger {
  background: rgba(255,68,68,.15);
  color: var(--red);
  border: 1px solid rgba(255,68,68,.2);
}

.btn-danger:hover {
  background: rgba(255,68,68,.25);
}

.btn-success {
  background: rgba(0,230,118,.15);
  color: var(--green);
  border: 1px solid rgba(0,230,118,.2);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS ROW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  padding: 24px 32px 0;
}

.stat-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
}

.stat-card.total::before  { background: var(--accent); }
.stat-card.active::before { background: var(--green); }
.stat-card.offline::before{ background: var(--red); }
.stat-card.cats::before   { background: var(--yellow); }

.stat-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: .8px;
  color: var(--text2);
  font-weight: 600;
  margin-bottom: 8px;
}

.stat-value {
  font-size: 32px;
  font-weight: 800;
  font-family: var(--mono);
  line-height: 1;
}

.stat-card.total  .stat-value { color: var(--accent); }
.stat-card.active .stat-value { color: var(--green); }
.stat-card.offline .stat-value { color: var(--red); }
.stat-card.cats   .stat-value { color: var(--yellow); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILTERS BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.filters-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 20px 32px 0;
  flex-wrap: wrap;
}

.filter-chip {
  padding: 6px 14px;
  border-radius: 20px;
  border: 1px solid var(--border2);
  background: var(--bg3);
  color: var(--text2);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
}

.filter-chip:hover { border-color: var(--accent); color: var(--accent); }

.filter-chip.active {
  background: rgba(0,194,255,.12);
  border-color: var(--accent);
  color: var(--accent);
}

.filter-chip.status-active { border-color: rgba(0,230,118,.3); }
.filter-chip.status-active.active { background: rgba(0,230,118,.1); border-color: var(--green); color: var(--green); }
.filter-chip.status-inactive { border-color: rgba(255,68,68,.2); }
.filter-chip.status-inactive.active { background: rgba(255,68,68,.1); border-color: var(--red); color: var(--red); }

.filter-sep { width: 1px; height: 20px; background: var(--border); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHANNELS TABLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.table-wrapper {
  padding: 20px 32px 32px;
  flex: 1;
}

.table-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 14px;
}

.table-count {
  font-size: 13px;
  color: var(--text2);
  font-family: var(--mono);
}

table {
  width: 100%;
  border-collapse: collapse;
}

thead tr {
  background: var(--bg3);
  border-bottom: 1px solid var(--border);
}

thead th {
  padding: 12px 16px;
  text-align: left;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: .8px;
  color: var(--text3);
  font-weight: 700;
  white-space: nowrap;
}

tbody tr {
  border-bottom: 1px solid var(--border);
  transition: var(--transition);
}

tbody tr:hover { background: rgba(255,255,255,.02); }

tbody td {
  padding: 14px 16px;
  vertical-align: middle;
}

.channel-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.channel-logo {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  background: var(--bg3);
  border: 1px solid var(--border2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  overflow: hidden;
  flex-shrink: 0;
}

.channel-logo img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.channel-name {
  font-weight: 700;
  font-size: 14px;
  color: var(--text);
}

.channel-slug {
  font-size: 11px;
  color: var(--text3);
  font-family: var(--mono);
  margin-top: 2px;
}

.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .4px;
}

.badge-active  { background: rgba(0,230,118,.12); color: var(--green); border: 1px solid rgba(0,230,118,.2); }
.badge-inactive{ background: rgba(255,68,68,.1); color: var(--red); border: 1px solid rgba(255,68,68,.15); }
.badge-testing { background: rgba(255,214,0,.1); color: var(--yellow); border: 1px solid rgba(255,214,0,.15); }

.stream-url {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text3);
  max-width: 220px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.stream-url a {
  color: var(--accent2);
  text-decoration: none;
}

.stream-url a:hover { color: var(--accent); text-decoration: underline; }

.servers-count {
  font-family: var(--mono);
  font-size: 13px;
  color: var(--text2);
  background: var(--bg3);
  border: 1px solid var(--border);
  padding: 3px 9px;
  border-radius: 6px;
  display: inline-block;
}

.actions-cell {
  display: flex;
  gap: 6px;
  align-items: center;
}

.icon-btn {
  width: 32px;
  height: 32px;
  border-radius: 7px;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 15px;
  transition: var(--transition);
}

.icon-btn-edit   { background: rgba(0,194,255,.08); color: var(--accent); }
.icon-btn-toggle { background: rgba(0,230,118,.08); color: var(--green); }
.icon-btn-toggle.off { background: rgba(255,68,68,.08); color: var(--red); }
.icon-btn-delete { background: rgba(255,68,68,.08); color: var(--red); }

.icon-btn:hover { transform: scale(1.1); filter: brightness(1.2); }

/* Empty state */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text3);
}

.empty-state .empty-icon { font-size: 48px; margin-bottom: 16px; display: block; }
.empty-state p { font-size: 15px; margin-bottom: 20px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.75);
  backdrop-filter: blur(4px);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal-overlay.open { display: flex; }

.modal {
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-radius: 14px;
  width: 100%;
  max-width: 680px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 24px 80px rgba(0,0,0,.6);
  animation: modalIn .2s ease;
}

@keyframes modalIn {
  from { opacity: 0; transform: scale(.95) translateY(10px); }
  to   { opacity: 1; transform: scale(1) translateY(0); }
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 22px 26px 18px;
  border-bottom: 1px solid var(--border);
}

.modal-header h3 {
  font-size: 18px;
  font-weight: 800;
}

.modal-close {
  width: 32px;
  height: 32px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 7px;
  cursor: pointer;
  color: var(--text2);
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
}

.modal-close:hover { background: rgba(255,68,68,.15); color: var(--red); border-color: rgba(255,68,68,.2); }

.modal-body {
  padding: 22px 26px;
}

.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.form-group.full { grid-column: 1 / -1; }

.form-label {
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .6px;
  color: var(--text2);
}

.form-label .required { color: var(--accent); margin-left: 2px; }

.form-input, .form-select, .form-textarea {
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: 8px;
  padding: 10px 14px;
  color: var(--text);
  font-family: var(--font);
  font-size: 14px;
  transition: var(--transition);
  outline: none;
  width: 100%;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(0,194,255,.1);
}

.form-input::placeholder, .form-textarea::placeholder { color: var(--text3); }

.form-select {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M5 6L0 0h10z' fill='%237a9bb5'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 32px;
}

.form-select option { background: var(--bg3); }

.form-textarea {
  resize: vertical;
  min-height: 80px;
  font-family: var(--mono);
  font-size: 13px;
}

/* Servidores dinÃ¡micos */
.servers-section {
  grid-column: 1 / -1;
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
}

.servers-section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: var(--bg3);
  border-bottom: 1px solid var(--border);
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .6px;
  color: var(--text2);
}

.servers-list { padding: 12px 16px; display: flex; flex-direction: column; gap: 10px; }

.server-row {
  display: grid;
  grid-template-columns: 1fr 90px 90px auto;
  gap: 8px;
  align-items: center;
}

.server-row .form-input { font-family: var(--mono); font-size: 12px; }

.btn-add-server {
  display: flex;
  align-items: center;
  gap: 6px;
  color: var(--accent);
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  padding: 6px 0;
  background: none;
  border: none;
  font-family: var(--font);
}

.btn-add-server:hover { opacity: .8; }

.btn-remove-server {
  width: 28px;
  height: 28px;
  background: rgba(255,68,68,.08);
  border: 1px solid rgba(255,68,68,.15);
  border-radius: 6px;
  color: var(--red);
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
  flex-shrink: 0;
}

.btn-remove-server:hover { background: rgba(255,68,68,.2); }

.modal-footer {
  display: flex;
  align-items: center;
  gap: 10px;
  justify-content: flex-end;
  padding: 18px 26px 22px;
  border-top: 1px solid var(--border);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IMPORT MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.import-tabs {
  display: flex;
  gap: 4px;
  background: var(--bg3);
  padding: 4px;
  border-radius: 8px;
  margin-bottom: 20px;
}

.import-tab {
  flex: 1;
  padding: 8px;
  text-align: center;
  font-size: 13px;
  font-weight: 700;
  border-radius: 6px;
  cursor: pointer;
  transition: var(--transition);
  color: var(--text2);
}

.import-tab.active {
  background: var(--bg2);
  color: var(--accent);
}

.import-panel { display: none; }
.import-panel.active { display: block; }

.drop-zone {
  border: 2px dashed var(--border2);
  border-radius: 10px;
  padding: 40px 20px;
  text-align: center;
  cursor: pointer;
  transition: var(--transition);
  color: var(--text3);
}

.drop-zone:hover, .drop-zone.dragging {
  border-color: var(--accent);
  background: rgba(0,194,255,.03);
  color: var(--text2);
}

.drop-zone .drop-icon { font-size: 36px; margin-bottom: 12px; display: block; }
.drop-zone p { font-size: 14px; }
.drop-zone small { font-size: 12px; color: var(--text3); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST NOTIFICATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast-container {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.toast {
  display: flex;
  align-items: center;
  gap: 12px;
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-radius: 10px;
  padding: 14px 18px;
  box-shadow: var(--shadow);
  font-size: 14px;
  font-weight: 600;
  min-width: 280px;
  animation: toastIn .25s ease;
}

@keyframes toastIn {
  from { opacity: 0; transform: translateX(20px); }
  to   { opacity: 1; transform: translateX(0); }
}

.toast.success { border-color: rgba(0,230,118,.3); }
.toast.success .toast-icon { color: var(--green); }
.toast.error   { border-color: rgba(255,68,68,.3); }
.toast.error   .toast-icon { color: var(--red); }
.toast.info    { border-color: rgba(0,194,255,.3); }
.toast.info    .toast-icon { color: var(--accent); }
.toast-icon { font-size: 18px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.loading-spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid rgba(0,194,255,.2);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin .6s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.skeleton {
  background: linear-gradient(90deg, var(--bg3) 25%, var(--border) 50%, var(--bg3) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.2s infinite;
  border-radius: 4px;
}

@keyframes shimmer {
  from { background-position: 200% 0; }
  to   { background-position: -200% 0; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGO PREVIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.logo-preview-row {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo-preview {
  width: 48px;
  height: 48px;
  border-radius: 8px;
  background: var(--bg3);
  border: 1px solid var(--border2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  overflow: hidden;
  flex-shrink: 0;
}

.logo-preview img { width: 100%; height: 100%; object-fit: contain; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API KEY BANNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.api-key-banner {
  margin: 16px 32px 0;
  padding: 14px 18px;
  background: rgba(255,214,0,.06);
  border: 1px solid rgba(255,214,0,.2);
  border-radius: 10px;
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 13px;
}

.api-key-banner.hidden { display: none; }
.api-key-banner .api-key-icon { font-size: 18px; }

.api-key-banner input {
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: 6px;
  padding: 6px 12px;
  color: var(--text);
  font-family: var(--mono);
  font-size: 13px;
  width: 220px;
  outline: none;
}

.api-key-banner input:focus { border-color: var(--yellow); }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <span class="logo-icon">ğŸŒ™</span>
    <h1>Moon TV</h1>
    <span>Panel de administraciÃ³n</span>
  </div>

  <nav class="sidebar-nav">
    <div class="nav-label">Contenido</div>
    <div class="nav-item active" onclick="setView('channels')">
      <span class="icon">ğŸ“º</span> Canales
      <span class="nav-badge" id="nav-total">â€”</span>
    </div>
    <div class="nav-item" onclick="setView('import')">
      <span class="icon">ğŸ“¥</span> Importar
    </div>

    <div class="nav-label" style="margin-top:8px">Herramientas</div>
    <div class="nav-item" onclick="testAllStreams()">
      <span class="icon">âš¡</span> Test streams
    </div>
    <div class="nav-item" onclick="exportChannels()">
      <span class="icon">ğŸ“¤</span> Exportar JSON
    </div>
    <div class="nav-item" onclick="exportM3U()">
      <span class="icon">ğŸ“‹</span> Exportar M3U
    </div>
  </nav>

  <div class="sidebar-footer">
    <div>API Base URL</div>
    <div class="api-url" id="api-url-display">/api/channels</div>
  </div>
</aside>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<main class="main">

  <!-- TOPBAR -->
  <div class="topbar">
    <h2 id="view-title">ğŸ“º Canales</h2>
    <div class="search-box">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="search-input" placeholder="Buscar canal..." oninput="debounceSearch()">
    </div>
    <button class="btn btn-ghost" onclick="loadChannels()">â†» Recargar</button>
    <button class="btn btn-primary" onclick="openNewChannel()">+ Nuevo canal</button>
  </div>

  <!-- API KEY BANNER -->
  <div class="api-key-banner" id="api-key-banner">
    <span class="api-key-icon">ğŸ”‘</span>
    <span>Clave de admin:</span>
    <input type="password" id="admin-key-input" placeholder="IngresÃ¡ tu ADMIN_KEY" oninput="saveAdminKey()">
    <span style="color:var(--text3);font-size:12px">Requerida para crear, editar y eliminar</span>
  </div>

  <!-- STATS -->
  <div class="stats-row" id="stats-row">
    <div class="stat-card total">
      <div class="stat-label">Total canales</div>
      <div class="stat-value" id="stat-total"><span class="skeleton" style="width:40px;height:32px;display:block"></span></div>
    </div>
    <div class="stat-card active">
      <div class="stat-label">Activos</div>
      <div class="stat-value" id="stat-active"><span class="skeleton" style="width:40px;height:32px;display:block"></span></div>
    </div>
    <div class="stat-card offline">
      <div class="stat-label">Inactivos</div>
      <div class="stat-value" id="stat-inactive"><span class="skeleton" style="width:40px;height:32px;display:block"></span></div>
    </div>
    <div class="stat-card cats">
      <div class="stat-label">CategorÃ­as</div>
      <div class="stat-value" id="stat-cats"><span class="skeleton" style="width:40px;height:32px;display:block"></span></div>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="filters-bar" id="filters-bar">
    <span class="filter-chip active" data-filter="all" onclick="setFilter('all', this)">Todos</span>
    <span class="filter-chip status-active" data-filter="active" onclick="setFilter('active', this)">ğŸŸ¢ Activos</span>
    <span class="filter-chip status-inactive" data-filter="inactive" onclick="setFilter('inactive', this)">ğŸ”´ Inactivos</span>
    <div class="filter-sep"></div>
    <span style="font-size:13px;color:var(--text3)">CategorÃ­a:</span>
    <div id="cat-filters" style="display:flex;gap:8px;flex-wrap:wrap"></div>
  </div>

  <!-- TABLE -->
  <div class="table-wrapper">
    <div class="table-header">
      <span class="table-count" id="table-count">Cargando...</span>
    </div>

    <div id="channels-view">
      <table>
        <thead>
          <tr>
            <th style="width:36px"><input type="checkbox" id="select-all" onchange="toggleSelectAll(this)"></th>
            <th>Canal</th>
            <th>CategorÃ­a</th>
            <th>Stream principal</th>
            <th>Servidores</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="channels-tbody">
          <!-- Skeletons -->
          <tr><td colspan="7"><div class="skeleton" style="height:52px;width:100%;margin:4px 0;border-radius:8px"></div></td></tr>
          <tr><td colspan="7"><div class="skeleton" style="height:52px;width:100%;margin:4px 0;border-radius:8px"></div></td></tr>
          <tr><td colspan="7"><div class="skeleton" style="height:52px;width:100%;margin:4px 0;border-radius:8px"></div></td></tr>
        </tbody>
      </table>
    </div>

    <!-- Import view -->
    <div id="import-view" style="display:none; max-width:640px; margin:0 auto">
      <h3 style="font-size:18px;font-weight:800;margin-bottom:20px">ğŸ“¥ Importar canales</h3>

      <div class="import-tabs">
        <div class="import-tab active" onclick="setImportTab('m3u', this)">Archivo M3U</div>
        <div class="import-tab" onclick="setImportTab('json', this)">JSON</div>
        <div class="import-tab" onclick="setImportTab('url', this)">URL M3U</div>
      </div>

      <div class="import-panel active" id="import-m3u">
        <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="dropFile(event)">
          <span class="drop-icon">ğŸ“‚</span>
          <p>ArrastrÃ¡ tu archivo .m3u o .m3u8 acÃ¡</p>
          <small>O hacÃ© click para seleccionar</small>
        </div>
        <input type="file" id="file-input" accept=".m3u,.m3u8,.txt" style="display:none" onchange="loadM3UFile(event)">
        <div id="m3u-preview" style="margin-top:16px;display:none">
          <div style="font-size:13px;color:var(--text2);margin-bottom:10px">
            Vista previa: <strong id="m3u-count">0 canales detectados</strong>
          </div>
          <div id="m3u-list" style="max-height:200px;overflow-y:auto;background:var(--bg3);border-radius:8px;padding:12px;font-family:var(--mono);font-size:12px;color:var(--text2);line-height:2"></div>
          <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="importM3U()">
            ğŸ“¥ Importar al servidor
          </button>
        </div>
      </div>

      <div class="import-panel" id="import-json">
        <div class="form-group">
          <label class="form-label">JSON de canales (array)</label>
          <textarea class="form-textarea" id="json-input" style="min-height:200px;font-size:12px" placeholder='[
  {
    "name": "Canal de Ejemplo",
    "category": "Noticias",
    "streamUrl": "https://...",
    "logo": "https://...",
    "country": "AR"
  }
]'></textarea>
        </div>
        <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="importJSON()">
          ğŸ“¥ Importar JSON
        </button>
      </div>

      <div class="import-panel" id="import-url">
        <div class="form-group">
          <label class="form-label">URL de lista M3U</label>
          <input type="url" class="form-input" id="m3u-url-input" placeholder="https://example.com/lista.m3u">
        </div>
        <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="importFromURL()">
          â¬‡ï¸ Cargar desde URL
        </button>
      </div>
    </div>
  </div>

</main>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL CANAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="channel-modal">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modal-title">Nuevo canal</h3>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>

    <div class="modal-body">
      <div class="form-grid">

        <!-- Nombre -->
        <div class="form-group">
          <label class="form-label">Nombre <span class="required">*</span></label>
          <input type="text" class="form-input" id="f-name" placeholder="ej: CNN en EspaÃ±ol" oninput="updateLogoPreview()">
        </div>

        <!-- CategorÃ­a -->
        <div class="form-group">
          <label class="form-label">CategorÃ­a</label>
          <select class="form-select" id="f-category">
            <option>General</option>
            <option>Noticias</option>
            <option>Deportes</option>
            <option>Entretenimiento</option>
            <option>PelÃ­culas</option>
            <option>Infantil</option>
            <option>MÃºsica</option>
            <option>Documentales</option>
            <option>Series</option>
            <option>Variedades</option>
            <option>Regional</option>
          </select>
        </div>

        <!-- Logo URL -->
        <div class="form-group full">
          <label class="form-label">Logo (URL de imagen)</label>
          <div class="logo-preview-row">
            <div class="logo-preview" id="logo-preview">ğŸ“º</div>
            <input type="url" class="form-input" id="f-logo" placeholder="https://..." oninput="updateLogoPreview()" style="flex:1">
          </div>
        </div>

        <!-- Stream principal -->
        <div class="form-group full">
          <label class="form-label">Stream principal <span class="required">*</span></label>
          <input type="url" class="form-input" id="f-stream" placeholder="https://stream.ejemplo.com/live.m3u8" style="font-family:var(--mono);font-size:13px">
        </div>

        <!-- Servidores adicionales -->
        <div class="form-group servers-section full">
          <div class="servers-section-header">
            <span>âš¡ Servidores de fallback</span>
            <button class="btn-add-server" onclick="addServerRow()">+ Agregar servidor</button>
          </div>
          <div class="servers-list" id="servers-list"></div>
        </div>

        <!-- PaÃ­s / Idioma -->
        <div class="form-group">
          <label class="form-label">PaÃ­s</label>
          <select class="form-select" id="f-country">
            <option value="AR">ğŸ‡¦ğŸ‡· Argentina</option>
            <option value="US">ğŸ‡ºğŸ‡¸ Estados Unidos</option>
            <option value="ES">ğŸ‡ªğŸ‡¸ EspaÃ±a</option>
            <option value="MX">ğŸ‡²ğŸ‡½ MÃ©xico</option>
            <option value="BR">ğŸ‡§ğŸ‡· Brasil</option>
            <option value="CO">ğŸ‡¨ğŸ‡´ Colombia</option>
            <option value="CL">ğŸ‡¨ğŸ‡± Chile</option>
            <option value="PE">ğŸ‡µğŸ‡ª PerÃº</option>
            <option value="VE">ğŸ‡»ğŸ‡ª Venezuela</option>
            <option value="GB">ğŸ‡¬ğŸ‡§ Reino Unido</option>
            <option value="INT">ğŸŒ Internacional</option>
          </select>
        </div>

        <!-- Estado -->
        <div class="form-group">
          <label class="form-label">Estado</label>
          <select class="form-select" id="f-status">
            <option value="active">ğŸŸ¢ Activo</option>
            <option value="inactive">ğŸ”´ Inactivo</option>
            <option value="testing">ğŸŸ¡ En prueba</option>
          </select>
        </div>

        <!-- Es pago / Orden -->
        <div class="form-group">
          <label class="form-label">Tipo</label>
          <select class="form-select" id="f-paid">
            <option value="false">ğŸ†“ Gratuito</option>
            <option value="true">ğŸ’ Premium</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Orden de apariciÃ³n</label>
          <input type="number" class="form-input" id="f-sort" value="0" min="0">
        </div>

        <!-- DescripciÃ³n -->
        <div class="form-group full">
          <label class="form-label">DescripciÃ³n (opcional)</label>
          <textarea class="form-textarea" id="f-desc" placeholder="DescripciÃ³n corta del canal..."></textarea>
        </div>

      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-primary" id="save-btn" onclick="saveChannel()">
        ğŸ’¾ Guardar canal
      </button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOAST CONTAINER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="toast-container" id="toast-container"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = window.location.origin;
let adminKey = localStorage.getItem('moon_admin_key') || '';
let editingId = null;
let allChannels = [];
let filteredChannels = [];
let currentFilter = 'all';
let currentCat = '';
let searchTimeout = null;
let m3uParsed = [];

// Inicializar
window.onload = () => {
  document.getElementById('admin-key-input').value = adminKey;
  updateApiDisplay();
  loadStats();
  loadChannels();
  loadCategories();
};

function updateApiDisplay() {
  document.getElementById('api-url-display').textContent = `${API}/api/channels`;
}

function saveAdminKey() {
  adminKey = document.getElementById('admin-key-input').value;
  localStorage.setItem('moon_admin_key', adminKey);
}

// â”€â”€â”€ VIEWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setView(view) {
  document.getElementById('channels-view').style.display = view === 'channels' ? 'block' : 'none';
  document.getElementById('import-view').style.display = view === 'import' ? 'block' : 'none';
  document.getElementById('filters-bar').style.display = view === 'channels' ? 'flex' : 'none';
  document.getElementById('stats-row').style.display = view === 'channels' ? 'grid' : 'none';
  document.getElementById('view-title').textContent = view === 'channels' ? 'ğŸ“º Canales' : 'ğŸ“¥ Importar canales';

  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  event.currentTarget.classList.add('active');
}

// â”€â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStats() {
  try {
    const r = await fetch(`${API}/api/channels/stats`);
    const { data } = await r.json();
    document.getElementById('stat-total').textContent   = data.total;
    document.getElementById('stat-active').textContent  = data.active;
    document.getElementById('stat-inactive').textContent = data.inactive;
    document.getElementById('stat-cats').textContent    = data.byCategory.length;
    document.getElementById('nav-total').textContent    = data.total;
  } catch (e) {
    ['stat-total','stat-active','stat-inactive','stat-cats'].forEach(id => {
      document.getElementById(id).textContent = 'â€”';
    });
  }
}

// â”€â”€â”€ CATEGORIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCategories() {
  try {
    const r = await fetch(`${API}/api/channels/categories`);
    const { data } = await r.json();
    const container = document.getElementById('cat-filters');
    container.innerHTML = data.map(cat =>
      `<span class="filter-chip" data-cat="${cat}" onclick="setCatFilter('${cat}', this)">${cat}</span>`
    ).join('');
  } catch (e) {}
}

// â”€â”€â”€ LOAD CHANNELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadChannels() {
  const q = document.getElementById('search-input').value;
  let url = `${API}/api/channels?all=true&limit=500`;
  if (currentFilter !== 'all') url += `&status=${currentFilter}`;
  if (currentCat)              url += `&category=${encodeURIComponent(currentCat)}`;
  if (q)                       url += `&q=${encodeURIComponent(q)}`;

  try {
    const r = await fetch(url);
    const { data, pagination } = await r.json();
    allChannels = data;
    renderTable(data, pagination);
  } catch (e) {
    showToast('error', 'âŒ No se pudo conectar con la API. Â¿El servidor estÃ¡ corriendo?');
    renderTable([], null);
  }
}

function renderTable(channels, pagination) {
  const tbody = document.getElementById('channels-tbody');
  document.getElementById('table-count').textContent =
    `${channels.length} canal${channels.length !== 1 ? 'es' : ''}`;

  if (!channels.length) {
    tbody.innerHTML = `
      <tr><td colspan="7">
        <div class="empty-state">
          <span class="empty-icon">ğŸ“º</span>
          <p>No hay canales todavÃ­a</p>
          <button class="btn btn-primary" onclick="openNewChannel()">+ Agregar el primero</button>
        </div>
      </td></tr>`;
    return;
  }

  tbody.innerHTML = channels.map(ch => {
    const statusBadge = {
      active:   '<span class="badge badge-active">â— Activo</span>',
      inactive: '<span class="badge badge-inactive">â— Inactivo</span>',
      testing:  '<span class="badge badge-testing">â— Test</span>',
    }[ch.status] || '';

    const logoHtml = ch.logo
      ? `<img src="${ch.logo}" onerror="this.style.display='none';this.nextSibling.style.display='block'"><span style="display:none">ğŸ“º</span>`
      : 'ğŸ“º';

    const serversCount = (ch.servers || []).length;

    return `
    <tr>
      <td><input type="checkbox" class="row-check" data-id="${ch._id}"></td>
      <td>
        <div class="channel-info">
          <div class="channel-logo">${logoHtml}</div>
          <div>
            <div class="channel-name">${esc(ch.name)}</div>
            <div class="channel-slug">${ch.slug || ''}</div>
          </div>
        </div>
      </td>
      <td><span style="font-size:13px;color:var(--text2)">${esc(ch.category || 'â€”')}</span></td>
      <td>
        <div class="stream-url">
          ${ch.streamUrl
            ? `<a href="${ch.streamUrl}" target="_blank" title="${ch.streamUrl}">${ch.streamUrl.replace(/https?:\/\//, '')}</a>`
            : '<span style="color:var(--text3)">Sin stream</span>'}
        </div>
      </td>
      <td>
        <span class="servers-count">${serversCount} srv</span>
      </td>
      <td>${statusBadge}</td>
      <td>
        <div class="actions-cell">
          <button class="icon-btn icon-btn-edit" title="Editar" onclick="openEditChannel('${ch._id}')">âœï¸</button>
          <button class="icon-btn icon-btn-toggle ${ch.status !== 'active' ? 'off' : ''}"
            title="${ch.status === 'active' ? 'Desactivar' : 'Activar'}"
            onclick="toggleStatus('${ch._id}', '${ch.status}')">
            ${ch.status === 'active' ? 'ğŸ‘ï¸' : 'ğŸš«'}
          </button>
          <button class="icon-btn icon-btn-delete" title="Eliminar" onclick="deleteChannel('${ch._id}', '${esc(ch.name)}')">ğŸ—‘ï¸</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€â”€ FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setFilter(filter, el) {
  currentFilter = filter;
  document.querySelectorAll('[data-filter]').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  loadChannels();
}

function setCatFilter(cat, el) {
  if (currentCat === cat) {
    currentCat = '';
    el.classList.remove('active');
  } else {
    currentCat = cat;
    document.querySelectorAll('[data-cat]').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
  }
  loadChannels();
}

function debounceSearch() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(loadChannels, 350);
}

// â”€â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNewChannel() {
  editingId = null;
  document.getElementById('modal-title').textContent = 'ğŸ“º Nuevo canal';
  document.getElementById('save-btn').textContent = 'ğŸ’¾ Crear canal';
  clearForm();
  document.getElementById('channel-modal').classList.add('open');
}

async function openEditChannel(id) {
  try {
    const r = await fetch(`${API}/api/channels/${id}`);
    const { data: ch } = await r.json();
    editingId = id;

    document.getElementById('modal-title').textContent = `âœï¸ Editar: ${ch.name}`;
    document.getElementById('save-btn').textContent = 'ğŸ’¾ Guardar cambios';

    document.getElementById('f-name').value     = ch.name || '';
    document.getElementById('f-category').value = ch.category || 'General';
    document.getElementById('f-logo').value     = ch.logo || '';
    document.getElementById('f-stream').value   = ch.streamUrl || '';
    document.getElementById('f-country').value  = ch.country || 'AR';
    document.getElementById('f-status').value   = ch.status || 'active';
    document.getElementById('f-paid').value     = String(ch.isPaid || false);
    document.getElementById('f-sort').value     = ch.sortOrder || 0;
    document.getElementById('f-desc').value     = ch.description || '';

    // Servers
    document.getElementById('servers-list').innerHTML = '';
    (ch.servers || []).forEach(s => addServerRow(s.url, s.label, s.type));

    updateLogoPreview();
    document.getElementById('channel-modal').classList.add('open');
  } catch(e) {
    showToast('error', 'Error cargando canal');
  }
}

function closeModal() {
  document.getElementById('channel-modal').classList.remove('open');
}

function clearForm() {
  ['f-name','f-logo','f-stream','f-desc'].forEach(id =>
    document.getElementById(id).value = '');
  document.getElementById('f-category').value = 'General';
  document.getElementById('f-country').value  = 'AR';
  document.getElementById('f-status').value   = 'active';
  document.getElementById('f-paid').value     = 'false';
  document.getElementById('f-sort').value     = '0';
  document.getElementById('servers-list').innerHTML = '';
  document.getElementById('logo-preview').innerHTML = 'ğŸ“º';
}

function updateLogoPreview() {
  const url = document.getElementById('f-logo').value;
  const preview = document.getElementById('logo-preview');
  if (url) {
    preview.innerHTML = `<img src="${url}" onerror="this.parentNode.innerHTML='ğŸ“º'">`;
  } else {
    const name = document.getElementById('f-name').value;
    preview.innerHTML = name ? name.slice(0,2).toUpperCase() : 'ğŸ“º';
  }
}

// â”€â”€â”€ SERVERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addServerRow(url = '', label = 'HD', type = 'hls') {
  const list = document.getElementById('servers-list');
  const row = document.createElement('div');
  row.className = 'server-row';
  row.innerHTML = `
    <input type="url" class="form-input srv-url" value="${esc(url)}" placeholder="https://stream.ejemplo.com/live.m3u8" style="font-family:var(--mono);font-size:12px">
    <input type="text" class="form-input srv-label" value="${esc(label)}" placeholder="HD">
    <select class="form-select srv-type">
      <option value="hls" ${type==='hls'?'selected':''}>HLS</option>
      <option value="mp4" ${type==='mp4'?'selected':''}>MP4</option>
      <option value="rtmp" ${type==='rtmp'?'selected':''}>RTMP</option>
      <option value="dash" ${type==='dash'?'selected':''}>DASH</option>
    </select>
    <button class="btn-remove-server" onclick="this.closest('.server-row').remove()">âœ•</button>
  `;
  list.appendChild(row);
}

// â”€â”€â”€ SAVE CHANNEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveChannel() {
  const name = document.getElementById('f-name').value.trim();
  const streamUrl = document.getElementById('f-stream').value.trim();

  if (!name) { showToast('error', 'El nombre es obligatorio'); return; }
  if (!streamUrl) { showToast('error', 'El stream principal es obligatorio'); return; }

  const servers = [...document.querySelectorAll('#servers-list .server-row')].map(row => ({
    url:   row.querySelector('.srv-url').value.trim(),
    label: row.querySelector('.srv-label').value.trim() || 'HD',
    type:  row.querySelector('.srv-type').value,
  })).filter(s => s.url);

  const payload = {
    name,
    category:    document.getElementById('f-category').value,
    logo:        document.getElementById('f-logo').value.trim(),
    streamUrl,
    country:     document.getElementById('f-country').value,
    status:      document.getElementById('f-status').value,
    isPaid:      document.getElementById('f-paid').value === 'true',
    sortOrder:   parseInt(document.getElementById('f-sort').value) || 0,
    description: document.getElementById('f-desc').value.trim(),
    servers,
  };

  const btn = document.getElementById('save-btn');
  btn.innerHTML = '<span class="loading-spinner"></span> Guardando...';
  btn.disabled = true;

  try {
    const method = editingId ? 'PUT' : 'POST';
    const url = editingId
      ? `${API}/api/channels/${editingId}`
      : `${API}/api/channels`;

    const r = await fetch(url, {
      method,
      headers: {
        'Content-Type': 'application/json',
        'x-admin-key': adminKey,
      },
      body: JSON.stringify(payload),
    });

    const result = await r.json();

    if (result.success) {
      showToast('success', result.message || 'âœ… Canal guardado');
      closeModal();
      loadChannels();
      loadStats();
      loadCategories();
    } else {
      showToast('error', result.message || 'Error guardando');
    }
  } catch(e) {
    showToast('error', 'Error de conexiÃ³n con el servidor');
  } finally {
    btn.innerHTML = 'ğŸ’¾ Guardar canal';
    btn.disabled = false;
  }
}

// â”€â”€â”€ TOGGLE STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleStatus(id, current) {
  const newStatus = current === 'active' ? 'inactive' : 'active';
  try {
    const r = await fetch(`${API}/api/channels/${id}/status`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', 'x-admin-key': adminKey },
      body: JSON.stringify({ status: newStatus }),
    });
    const result = await r.json();
    if (result.success) {
      showToast('success', result.message);
      loadChannels();
      loadStats();
    }
  } catch(e) {
    showToast('error', 'Error actualizando estado');
  }
}

// â”€â”€â”€ DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function deleteChannel(id, name) {
  if (!confirm(`Â¿Eliminar el canal "${name}"? Esta acciÃ³n no se puede deshacer.`)) return;
  try {
    const r = await fetch(`${API}/api/channels/${id}`, {
      method: 'DELETE',
      headers: { 'x-admin-key': adminKey },
    });
    const result = await r.json();
    if (result.success) {
      showToast('success', `ğŸ—‘ï¸ ${result.message}`);
      loadChannels();
      loadStats();
    } else {
      showToast('error', result.message);
    }
  } catch(e) {
    showToast('error', 'Error eliminando canal');
  }
}

// â”€â”€â”€ SELECT ALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSelectAll(cb) {
  document.querySelectorAll('.row-check').forEach(c => c.checked = cb.checked);
}

// â”€â”€â”€ IMPORT M3U â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setImportTab(tab, el) {
  document.querySelectorAll('.import-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.import-panel').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById(`import-${tab}`).classList.add('active');
}

function dragOver(e) {
  e.preventDefault();
  document.getElementById('drop-zone').classList.add('dragging');
}

function dragLeave() {
  document.getElementById('drop-zone').classList.remove('dragging');
}

function dropFile(e) {
  e.preventDefault();
  dragLeave();
  const file = e.dataTransfer.files[0];
  if (file) readM3UFile(file);
}

function loadM3UFile(e) {
  const file = e.target.files[0];
  if (file) readM3UFile(file);
}

function readM3UFile(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    const parsed = parseM3U(e.target.result);
    m3uParsed = parsed;
    document.getElementById('m3u-count').textContent = `${parsed.length} canales detectados`;
    document.getElementById('m3u-list').innerHTML = parsed.slice(0,50).map(ch =>
      `<div>ğŸ“º <strong>${esc(ch.name)}</strong> <span style="color:var(--text3)">[${ch.category}]</span></div>`
    ).join('') + (parsed.length > 50 ? `<div style="color:var(--text3)">...y ${parsed.length - 50} mÃ¡s</div>` : '');
    document.getElementById('m3u-preview').style.display = 'block';
    showToast('info', `ğŸ“‹ ${parsed.length} canales parseados del archivo M3U`);
  };
  reader.readAsText(file);
}

function parseM3U(content) {
  const lines = content.split('\n').map(l => l.trim()).filter(Boolean);
  const channels = [];
  let current = null;
  for (const line of lines) {
    if (line.startsWith('#EXTINF:')) {
      const tvgName    = line.match(/tvg-name="([^"]+)"/);
      const tvgLogo    = line.match(/tvg-logo="([^"]+)"/);
      const groupTitle = line.match(/group-title="([^"]+)"/);
      const nameEnd    = line.lastIndexOf(',');
      current = {
        name:     nameEnd >= 0 ? line.slice(nameEnd+1).trim() : (tvgName?.[1] || 'Canal'),
        logo:     tvgLogo?.[1] || '',
        category: groupTitle?.[1] || 'General',
        country:  'AR',
        status:   'active',
        servers:  [],
      };
    } else if (current && !line.startsWith('#') && (line.startsWith('http') || line.startsWith('rtmp'))) {
      current.streamUrl = line;
      current.servers   = [{ url: line, label: 'HD', type: 'hls' }];
      channels.push(current);
      current = null;
    }
  }
  return channels;
}

async function importM3U() {
  if (!m3uParsed.length) { showToast('error', 'No hay canales para importar'); return; }
  await doImport({ channels: m3uParsed });
}

async function importJSON() {
  try {
    const channels = JSON.parse(document.getElementById('json-input').value);
    if (!Array.isArray(channels)) throw new Error('Debe ser un array');
    await doImport({ channels });
  } catch(e) {
    showToast('error', `JSON invÃ¡lido: ${e.message}`);
  }
}

async function importFromURL() {
  const url = document.getElementById('m3u-url-input').value.trim();
  if (!url) { showToast('error', 'IngresÃ¡ una URL'); return; }
  showToast('info', 'â¬‡ï¸ Descargando lista...');
  try {
    const r = await fetch(url);
    const text = await r.text();
    const channels = parseM3U(text);
    showToast('info', `ğŸ“‹ ${channels.length} canales en la lista`);
    await doImport({ channels });
  } catch(e) {
    showToast('error', 'No se pudo cargar la URL (puede ser CORS)');
  }
}

async function doImport(body) {
  try {
    const r = await fetch(`${API}/api/channels/import`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-admin-key': adminKey },
      body: JSON.stringify(body),
    });
    const result = await r.json();
    if (result.success) {
      showToast('success', result.message);
      loadStats();
    } else {
      showToast('error', result.message);
    }
  } catch(e) {
    showToast('error', 'Error importando');
  }
}

// â”€â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function exportChannels() {
  const r = await fetch(`${API}/api/channels?all=true&limit=1000`);
  const { data } = await r.json();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  download(blob, 'moon-tv-channels.json');
  showToast('success', `ğŸ“¤ ${data.length} canales exportados`);
}

async function exportM3U() {
  const r = await fetch(`${API}/api/channels?all=true&limit=1000`);
  const { data } = await r.json();
  let m3u = '#EXTM3U\n';
  data.forEach(ch => {
    m3u += `#EXTINF:-1 tvg-name="${ch.name}" tvg-logo="${ch.logo || ''}" group-title="${ch.category || 'General'}",${ch.name}\n`;
    m3u += `${ch.streamUrl}\n`;
  });
  const blob = new Blob([m3u], { type: 'audio/x-mpegurl' });
  download(blob, 'moon-tv-channels.m3u');
  showToast('success', `ğŸ“‹ M3U exportado con ${data.length} canales`);
}

function download(blob, filename) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

// â”€â”€â”€ TEST STREAMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function testAllStreams() {
  showToast('info', 'âš¡ Testeando streams... (prÃ³ximamente)');
}

// â”€â”€â”€ TOASTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(type, message) {
  const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸' };
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `<span class="toast-icon">${icons[type]}</span><span>${message}</span>`;
  document.getElementById('toast-container').appendChild(toast);
  setTimeout(() => toast.style.opacity = '0', 3200);
  setTimeout(() => toast.remove(), 3500);
}

// Cerrar modal con ESC
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
});

// Cerrar modal clickeando overlay
document.getElementById('channel-modal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
</script>
</body>
</html>
